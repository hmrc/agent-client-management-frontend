@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import java.time.LocalDate

@import uk.gov.hmrc.agentclientmanagementfrontend.config.AppConfig
@import uk.gov.hmrc.agentclientmanagementfrontend.controllers.routes
@import uk.gov.hmrc.agentclientmanagementfrontend.views.AuthorisedAgentsPageConfig
@import uk.gov.hmrc.agentclientmanagementfrontend.views.html.main_template
@import uk.gov.hmrc.agentclientmanagementfrontend.views.html.components._
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AgentRequest
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTabs
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.Tabs
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.TabItem
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTable
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.Table
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.HeadCell
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.TableRow
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.HtmlContent
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.TabPanel

@this(
    mainTemplate: main_template,
    govukTabs: GovukTabs,
    govukTable: GovukTable
)

@(config: AuthorisedAgentsPageConfig)(implicit messages: Messages, request: Request[_], appConfig: AppConfig, now: LocalDate)

@pendingNo = @{
    if(config.validPendingCount == 1) {
    Messages("client-authorised-agents-table-relationships.pendingNo.single", config.validPendingCount)
    }else {
    Messages("client-authorised-agents-table-relationships.pendingNo", config.validPendingCount)
    }
}

@currentRequests = {
    @govukTable(Table(
        head = Some(Seq(
            HeadCell(content = Text(Messages("client-authorised-agents-table.current.agentName"))),
            HeadCell(content = Text(Messages("client-authorised-agents-table.current.taxService"))),
            HeadCell(content = Text(Messages("client-authorised-agents-table.current.expiryDate"))),
            HeadCell(content = Text(Messages("client-authorised-agents-table.current.action")))
        )),
        rows = config.displayValidPendingRequests.map { agentReq =>
          Seq(
            TableRow(content = Text(agentReq.agencyName), attributes = Map("style" -> "font-weight: bold")),
            TableRow(content = Text(agentReq.serviceName)),
            TableRow(content = Text(config.displayDate(Some(agentReq.expiryDate)))),
            TableRow(content = HtmlContent(Html(
                s"""<a href="${appConfig.warmUpUrl(agentReq.clientType, agentReq.uid, agentReq.agencyName)}">
                   |    <span aria-hidden="true">${Messages("client-authorised-agents-table.actions.respond")}</span>
                   |    <span class="govuk-visually-hidden">${Messages("client-authorised-agents-table.actions.respond")} ${agentReq.agencyName} ${Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}")}</span>
                   |    </a>
                   |""".stripMargin)
            )),
          )
        }
    ))
}

@currentAuths = {
    <h2 class="margin-top-0">@Messages("client-authorised-agents-table-relationships.tab2.title")</h2>
    @if(!config.authorisedAgentsExist) {
      <p>@Messages("client-authorised-agents-table-content.noAgentsFound")</p>
    } else {
      @govukTable(Table(
        head = Some(Seq(
          HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.agentName"))),
          HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.authServices"))),
          HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.dateAuthorised"))),
          HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.actions")))
        )),
        rows = config.authorisedAgents.map { authAgent =>
          Seq(
            TableRow(content = Text(authAgent.agencyName), attributes = Map("style" -> "font-weight: bold")),
            TableRow(content = Text(Messages(s"client-authorised-agents-table-content.${authAgent.serviceName}"))),
            TableRow(content = Text(config.displayDate(authAgent.dateFrom))),
            TableRow(content = if (!appConfig.featuresRemoveAuthorisation(authAgent.serviceName)) Text("") else
              HtmlContent(
                s"""<a href="${routes.ClientRelationshipManagementController.showRemoveAuthorisation(authAgent.serviceName, authAgent.uuId)}">
                   |    <span aria-hidden="true"> ${Messages("client-authorised-agents-table-row-header.unauthoriseLink")}</span>
                   |    <span class="govuk-visually-hidden">${Messages("client-authorised-agents-table-row-header.unauthoriseLink.aria-text", authAgent.agencyName, Messages(s"client-authorised-agents-table-content.${authAgent.serviceName}"))}</span>
                   |</a>
                   |""".stripMargin
              )
            )
          )
        }
      ))
    }
}

@history = {
   <h2 class="margin-top-0">@Messages("client-authorised-agents-table-relationships.tab3.title")</h2>
   @if(!config.validNonPendingRequestsExist) {
       <p>@Messages("client-authorised-agents-table-content.no-activity")</p>
   } else {
     <div class="govuk-body govuk-!-margin-0">
         @messages("pager.showing")
         <span style="font-weight: bold">@{config.firstItemOnPage + 1}</span>
         @messages("pager.to")
         <span style="font-weight: bold">@{config.lastItemOnPage}</span>
         @messages("pager.of")
         <span style="font-weight: bold">@{config.allItems.length}</span>
     </div>
     @govukTable(Table(
       head = Some(Seq(
         HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.agentName"))),
         HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.authRequested"))),
         HeadCell(content = Text(Messages("client-authorised-agents-table-row-header.status"))),
       )),
       rows = config.visibleItems.sortWith(_.agencyName < _.agencyName).sorted(AgentRequest.orderingByLastUpdated).map { agentReq =>
         Seq(
           TableRow(content = Text(agentReq.agencyName), attributes = Map("style" -> "font-weight: bold")),
           TableRow(content = Text(Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}"))),
           TableRow(content = HtmlContent(s"""${Messages(s"client-authorised-agents-table.${agentReq.status}")}
                                             |<span class="date-hint">${config.displayDate(Some(agentReq.lastUpdated.toLocalDate))}</span>
                                             |""".stripMargin)
           )
         )
       }
     ))
     @pager(config)
   }
}

@tabItems = @{
    val currentRequestsTab = TabItem(id = Some("currentRequests"), label = Messages("client-authorised-agents-table-relationships.tab1.title"), panel = TabPanel(content = HtmlContent(currentRequests)))
    val currentAuthsTab    = TabItem(id = Some("currentAuths"), label = Messages("client-authorised-agents-table-relationships.tab2.title"), panel = TabPanel(content = HtmlContent(currentAuths)))
    val historyTab         = TabItem(id = Some("history"), label = Messages("client-authorised-agents-table-relationships.tab3.title"), panel = TabPanel(content = HtmlContent(history)))
    if (config.validPendingRequestsExist)
      Seq(currentRequestsTab, currentAuthsTab, historyTab)
    else
      Seq(currentAuthsTab, historyTab)
}

@mainTemplate(title = Messages("client-authorised-agents.title"), wide = true){

    <h1 class="govuk-heading-l margin-bottom-25">@Messages("client-authorised-agents.title")</h1>

    <p>@Messages("client-authorised-agents.p")</p>

    <ul class="govuk-list govuk-list--bullet">
        <li>@Messages("client-authorised-agents.li.1")</li>
        <li>@Messages("client-authorised-agents.li.2")</li>
        <li>@Messages("client-authorised-agents.li.3")</li>
        <li>@Messages("client-authorised-agents.li.4")</li>
    </ul>

    <p class="margin-bottom-30"><a href="https://www.gov.uk/guidance/client-authorisation-an-overview#how-to-change-or-cancel-authorisations-as-an-agent">@Messages("client-authorised-agents.link.text")</a></p>

    @govukTabs(Tabs(
        items = tabItems
    ))

}

@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AuthorisedAgent
@import uk.gov.hmrc.agentclientmanagementfrontend.controllers.routes
@import org.joda.time.LocalDate

@import uk.gov.hmrc.agentclientmanagementfrontend.config.ExternalUrls

@import uk.gov.hmrc.agentclientmanagementfrontend.models.AgentRequest
@(authorisedAgents: Seq[AuthorisedAgent],agentRequests:Seq[AgentRequest])(implicit messages: Messages, request: Request[_], configuration: Configuration, externalUrls: ExternalUrls, now: LocalDate)

@displayDate(date: Option[LocalDate]) = @{
    date match {
        case Some(d) => d.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }
}

@pendingNo = @{
    val count = agentRequests.count(_.effectiveStatus == "Pending")
    if(count == 1) {
        Messages("client-authorised-agents-table-relationships.pendingNo.single", count)
    }else {
        Messages("client-authorised-agents-table-relationships.pendingNo", count)
    }
}

@dateInfo(request: AgentRequest)(implicit messages: Messages) = {
    @if(request.effectiveStatus == "Expired") {
        @displayDate(Some(request.expiryDate))
    } else {
        @displayDate(Some(request.lastUpdated))
    }
}

@notificationNo = @{agentRequests.count(_.effectiveStatus == "Pending")}

@uk.gov.hmrc.agentclientmanagementfrontend.views.html.main_template(title = Messages("client-authorised-agents.title"), bodyClasses = Some("full-width")){

    <h1 class="heading-large">@Messages("client-authorised-agents.title")</h1>

    <div class="govuk-tabs" data-module="tabs">
        <h2 class="govuk-tabs__title">
          @Messages("client-authorised-agents.title")
        </h2>

        <ul class="govuk-tabs__list">
            @if(agentRequests.exists(_.effectiveStatus == "Pending")) {
                <li class="govuk-tabs__list-item">
                    <a class="govuk-tabs__tab govuk-tabs__tab--selected" href="#currentRequests">
                    @Messages("client-authorised-agents-table-relationships.tab1.title")
                    </a>
                </li>
            }
            <li class="govuk-tabs__list-item">
                <a class="govuk-tabs__tab" href="#currentAuths">
                    @Messages("client-authorised-agents-table-relationships.tab2.title")
                </a>
            </li>
            <li class="govuk-tabs__list-item">
                <a class="govuk-tabs__tab" href="#history">
                    @Messages("client-authorised-agents-table-relationships.tab3.title")
                </a>
            </li>
        </ul>

        @if(agentRequests.exists(_.effectiveStatus == "Pending")) {
        <section class="govuk-tabs__panel" id="currentRequests">
            <h2 class="margin-top-0">@Messages("client-authorised-agents-table-relationships.tab1.title")</h2>
            <p class="panel panel-border-wide">@pendingNo</p>
                <table class="font-small">
                    <colgroup>
                        <col width="55%">
                        <col width="25%">
                        <col width="20%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th scope="col">@Messages("client-authorised-agents-table.current.agentName")</th>
                            <th scope="col">@Messages("client-authorised-agents-table.current.expiryDate")</th>
                            <th scope="col" >@Messages("client-authorised-agents-table.current.action")</th>
                        </tr>
                    </thead>
                    <tbody>
                    @agentRequests.filter(_.effectiveStatus == "Pending").map { agentReq =>
                        <tr>
                            <td>@agentReq.agencyName</td>
                            <td>@displayDate(Some(agentReq.expiryDate))</td>
                            <td >
                            @Html(Messages("client-authorised-agents-table.actions.respond", externalUrls.confirmTermsUrl(agentReq.invitationId)))
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            }

        </section>
        <section class="govuk-tabs__panel govuk-tabs__panel--hidden" id="currentAuths">
            <h2 class="margin-top-0">@Messages("client-authorised-agents-table-relationships.tab2.title")</h2>
            @if(authorisedAgents.nonEmpty){
                <p>@Messages("client-authorised-agents-table-relationships.tab2.p")</p>
                <table class="font-small">
                    <colgroup>
                        <col width="20%">
                        <col width="35%">
                        <col width="25%">
                        <col width="20%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.authServices")</th>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.dateAuthorised")</th>
                            <th scope="col" >@Messages("client-authorised-agents-table-row-header.actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @authorisedAgents.map{ authAgent =>
                            <tr>
                                <td>@authAgent.agencyName</td>
                                <td>@Messages(s"client-authorised-agents-table-content.${authAgent.serviceName}")</td>
                                <td>@displayDate(authAgent.dateFrom)</td>
                                <td>@if(configuration.getBoolean(s"features.remove-authorisation.${authAgent.serviceName}").getOrElse(false) == true){<a href="@routes.ClientRelationshipManagementController.showRemoveAuthorisation(authAgent.serviceName, authAgent.uuId)">@Messages("client-authorised-agents-table-row-header.unauthoriseLink")</a>}</td>
                            </tr>
                        }
                    }else{
                <p>@Messages("client-authorised-agents-table-content.noAgentsFound")</p>
            }
        </tbody>
        </table>

        </section>
        <section class="govuk-tabs__panel govuk-tabs__panel--hidden" id="history">
            <h2 class="margin-top-0">@Messages("client-authorised-agents-table-relationships.tab3.title")</h2>
            @if(agentRequests.nonEmpty){
                <p>@Messages("client-authorised-agents-table-relationships.tab3.p")</p>
                <table class="font-small">
                    <colgroup>
                        <col width="30%">
                        <col width="35%">
                        <col width="35%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.authRequested")</th>
                            <th scope="col">@Messages("client-authorised-agents-table-row-header.status")</th>
                        </tr>
                    </thead>
                    <tbody>

                        @agentRequests.filter(_.effectiveStatus != "Pending").map { agentReq =>
                            <tr>
                                <td>@agentReq.agencyName</td>
                                <td>@Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}")</td>
                                <td>@Messages(s"client-authorised-agents-table.${agentReq.effectiveStatus}")<span class="date-hint">
                                @dateInfo(agentReq)</span></td>
                                </td>
                            </tr>
                        }

                    }else{
                <p>@Messages("client-authorised-agents-table-content.no-activity")</p>
            }
        </tbody>
        </table>

        </section>
    </div>

}

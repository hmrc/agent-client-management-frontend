@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AuthorisedAgent
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AgentRequest
@import uk.gov.hmrc.agentclientmanagementfrontend.controllers.routes
@import org.joda.time.LocalDate

@import uk.gov.hmrc.agentclientmanagementfrontend.config.ExternalUrls

@(authorisedAgents: Seq[AuthorisedAgent],agentRequests:Seq[AgentRequest])(implicit messages: Messages, request: Request[_], configuration: Configuration, externalUrls: ExternalUrls)

@displayDate(date: Option[LocalDate]) = @{
    date match {
        case Some(d) => d.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }
}

@notificationNo = @{agentRequests.count(_.status == "Pending")}

@tomato = @{
    if(notificationNo>0){
        """<span class="badge">""" + notificationNo + """</span>"""
    } else ""
}

@uk.gov.hmrc.agentclientmanagementfrontend.views.html.main_template(title = Messages("client-authorised-agents.title"), bodyClasses = Some("full-width")){

    <h1 class="heading-large">@Messages("client-authorised-agents.title")</h1>



    <div data-tabs-custom class="js-hash-selected-tab">
        <ul class="tabs-nav" role="tablist">

            <li id="tab1" data-tab-link="1" role="tab" aria-selected="true" aria-controls="tabContent1" tabindex="0">
                <a href="#tabContent1"><span class="tabs-nav__tab">@Html(Messages("client-authorised-agents-table-relationships.tab1.title", tomato))</span></a>
            </li>
            <li id="tab2" data-tab-link="2" role="tab" aria-selected="true" aria-controls="tabContent2" tabindex="1">
                <a href="#tabContent2"><span class="tabs-nav__tab">@Messages("client-authorised-agents-table-relationships.title")</span></a>
            </li>
        </ul>
        <ul>
            <li id="tabContent1" data-tab-content="1" class="tab-content" role="tabpanel" aria-labelledby="tab1">
                <div class="tab-content__first">
                    <table class="font-small">
                        <caption class="visuallyhidden">@Messages("client-authorised-agents-table-relationships.title")</caption>
                        <p>@Messages("client-authorised-agents.tab1.p1")</p>

                        <colgroup>
                            <col width="">
                            <col width="">
                            <col width="20%">
                            <col width="18%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.authRequested")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.requestStatus")</th>
                                <th scope="col" class="text--right">@Messages("client-authorised-agents-table-row-header.actions")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if(agentRequests.nonEmpty){
                                @agentRequests.map { agentReq =>
                                    <tr>
                                        <td>@agentReq.agencyName</td>
                                        <td>@Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}")</td>
                                        <td>@Messages(s"client-authorised-agents-table.${agentReq.status}")<span style="display: block; font-size: 0.85em; color: #6f777b;">
                                            @{agentReq.status match {
                                            case "Pending" => Messages("client-authorised-agents-table.pending.date", displayDate(Some(agentReq.expiryDate)))
                                            case "Expired" => displayDate(Some(agentReq.expiryDate))
                                            case _ => displayDate(Some(agentReq.lastUpdated))
                                        }
                                        }</span></td>
                                        <td class="text--right">
                                        @{agentReq.status match {
                                            case "Pending" => Html(Messages("client-authorised-agents-table.actions.respond", externalUrls.confirmTermsUrl(agentReq.invitationId)))
                                            case "Accepted" => Html(Messages("client-authorised-agents-table.actions.remove", externalUrls.confirmDeclineUrl(agentReq.invitationId)))
                                            case _ => Messages("client-authorised-agents-table.actions.no-action")
                                        }
                                        }
                                        </td>
                                    </tr>

                                }

                            }else{
                            <tr>
                            <td colspan="4" scope="row">@Messages("client-authorised-agents-table-content.noRequests")</td>
                        </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </li>
            <li id="tabContent2" data-tab-content="2" class="tab-content" role="tabpanel" aria-labelledby="tab2">
                <div class="tab-content__first">
                    <table class="font-small">
                        <caption class="visuallyhidden">@Messages("client-authorised-agents-table-relationships.title")</caption>
                        <p>@Messages("client-authorised-agents.tab2.p1")</p>
                        <colgroup>
                            <col width="">
                            <col width="">
                            <col width="20%">
                            <col width="18%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.serviceName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.dateAuthorised")</th>
                                <th scope="col" class="text--right">@Messages("client-authorised-agents-table-row-header.actions")</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if(authorisedAgents.nonEmpty){
                            @authorisedAgents.map{ authAgent =>
                                <tr>
                                    <td>@authAgent.agencyName</td>
                                    <td>@Messages(s"client-authorised-agents-table-content.${authAgent.serviceName}")</td>
                                    <td>@displayDate(authAgent.dateFrom)</td>
                                 <td class="text--right"><a@if(configuration.getBoolean(s"features.remove-authorisation.${authAgent.serviceName}").getOrElse(false) == true){ href="@routes.ClientRelationshipManagementController.submitRemoveAuthorisation(authAgent.serviceName, authAgent.uuId)">@Messages("client-authorised-agents-table-row-header.unauthoriseLink")}</a></td>
                                </tr>
                            }
                        }else{
                            <tr>
                                <td colspan="4" scope="row">@Messages("client-authorised-agents-table-content.noAgentsFound")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </li>
        </ul>
    </div>

}

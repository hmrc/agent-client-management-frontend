@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AuthorisedAgent
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AgentRequest
@import uk.gov.hmrc.agentclientmanagementfrontend.controllers.routes
@import org.joda.time.LocalDate

@import uk.gov.hmrc.agentclientmanagementfrontend.config.ExternalUrls

@(authorisedAgents: Seq[AuthorisedAgent],agentRequests:Seq[AgentRequest])(implicit messages: Messages, request: Request[_], configuration: Configuration, externalUrls: ExternalUrls, now: LocalDate)

@displayDate(date: Option[LocalDate]) = @{
    date match {
        case Some(d) => d.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }
}

@dateInfo(request: AgentRequest)(implicit messages: Messages) = {
@if(request.effectiveStatus == "Pending") {
    <span>@Messages("client-authorised-agents-table.pending.date", displayDate(Some(request.expiryDate)))</span>
} else {
    @if(request.effectiveStatus == "Expired") {
        @displayDate(Some(request.expiryDate))
    } else {
        @displayDate(Some(request.lastUpdated))
    }
}

}

@notificationNo = @{agentRequests.count(_.effectiveStatus == "Pending")}

@tomato = @{
    if(notificationNo>0){
        """<span class="badge">""" + notificationNo + """</span>"""
    } else ""
}

@uk.gov.hmrc.agentclientmanagementfrontend.views.html.main_template(title = Messages("client-authorised-agents.title"), bodyClasses = Some("full-width")){

    <h1 class="heading-large">@Messages("client-authorised-agents.title")</h1>



    <div data-tabs-custom class="js-hash-selected-tab">
        <ul class="tabs-nav" role="tablist">

            <li id="tabRequests" data-tab-link="tabLinkRequests" role="tab" aria-selected="true" aria-controls="tab_requests" tabindex="0">
                <a href="#tab_requests"><span class="tabs-nav__tab">@Html(Messages("client-authorised-agents-table-relationships.tab1.title", tomato))</span></a>
            </li>
            <li id="tabRelationships" data-tab-link="tabLinkRelationships" role="tab" aria-selected="true" aria-controls="tab_relationships" tabindex="1">
                <a href="#tab_relationships"><span class="tabs-nav__tab">@Messages("client-authorised-agents-table-relationships.tab2.title")</span></a>
            </li>
        </ul>
        <ul>
            <li id="tab_requests" data-tab-content="tabLinkRequests" class="tab-content" role="tabpanel" aria-labelledby="tabRequests">
                <div class="tab-content__first">
                    @if(agentRequests.exists(_.effectiveStatus == "Pending") && authorisedAgents.nonEmpty) {
                        <p>@Messages("client-authorised-agents.tab1.p1.both")</p>
                    }else{
                        <p>@Messages("client-authorised-agents.tab1.p1.only-auth")</p>
                    }
                    @if(agentRequests.exists(_.effectiveStatus == "Pending")) {
                        <table class="font-small margin-bottom-30">
                            <caption class="caption-medium">@Messages("client-authorised-agents-table-relationships.pending")</caption>

                            <colgroup>
                                <col width="">
                                <col width="">
                                <col width="15%">
                                <col width="18%">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                                    <th scope="col">@Messages("client-authorised-agents-table-row-header.authRequested")</th>
                                    <th scope="col">@Messages("client-authorised-agents-table-row-header.pending")</th>
                                    <th scope="col" class="text--right">@Messages("client-authorised-agents-table-row-header.actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @agentRequests.filter(_.effectiveStatus == "Pending").map { agentReq =>
                                    <tr>
                                        <td>@agentReq.agencyName</td>
                                        <td>@Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}")</td>
                                        <td>@displayDate(Some(agentReq.expiryDate))</td>
                                        <td class="text--right">
                                            @Html(Messages("client-authorised-agents-table.actions.respond", externalUrls.confirmTermsUrl(agentReq.invitationId)))
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    @if(authorisedAgents.nonEmpty){
                    <table class="font-small margin-top-30">
                        <colgroup>
                            <col width="">
                            <col width="">
                            <col width="15%">
                            <col width="18%">
                        </colgroup>
                        <caption class="caption-medium">@Messages("client-authorised-agents-table-relationships.current")</caption>
                        <thead>
                            <tr>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.authRequested")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.dateAuthorised")</th>
                                <th scope="col" class="text--right">@Messages("client-authorised-agents-table-row-header.actions")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @authorisedAgents.map{ authAgent =>
                                <tr>
                                    <td>@authAgent.agencyName</td>
                                    <td>@Messages(s"client-authorised-agents-table-content.${authAgent.serviceName}")</td>
                                    <td>@displayDate(authAgent.dateFrom)</td>
                                    <td class="text--right"><a@if(configuration.getBoolean(s"features.remove-authorisation.${authAgent.serviceName}").getOrElse(false) == true){ href="@routes.ClientRelationshipManagementController.showRemoveAuthorisation(authAgent.serviceName, authAgent.uuId)">@Messages("client-authorised-agents-table-row-header.unauthoriseLink")}</a></td>
                                </tr>
                            }
                        }else{
                          <h2 class="heading-medium">@Messages("client-authorised-agents-table-relationships.current")</h2>
                          <p>@Messages("client-authorised-agents-table-content.noAgentsFound")</p>
                        }
                        </tbody>
                    </table>
                </div>
            </li>
            <li id="tab_relationships" data-tab-content="tabLinkRelationships" class="tab-content" role="tabpanel" aria-labelledby="tabRelationships">
                <div class="tab-content__first">
                    <p>@Messages("client-authorised-agents.tab2.p1")</p>
                    @if(agentRequests.nonEmpty){
                    <table class="font-small">
                        <thead>
                            <tr>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.agentName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.serviceName")</th>
                                <th scope="col">@Messages("client-authorised-agents-table-row-header.status")</th>
                            </tr>
                        </thead>
                        <tbody>

                            @agentRequests.map { agentReq =>
                                <tr>
                                    <td>@agentReq.agencyName</td>
                                    <td>@Messages(s"client-authorised-agents-table-content.${agentReq.serviceName}")</td>
                                    <td>@Messages(s"client-authorised-agents-table.${agentReq.effectiveStatus}")<span class="date-hint">
                                    @dateInfo(agentReq)</span></td>
                                    </td>
                                </tr>
                            }

                        }else{
                                <p>@Messages("client-authorised-agents-table-content.no-history")</p>
                        }
                        </tbody>
                    </table>
                </div>
            </li>
        </ul>
    </div>

}

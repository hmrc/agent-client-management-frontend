@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import java.time.LocalDate

@import uk.gov.hmrc.agentclientmanagementfrontend.config.AppConfig
@import uk.gov.hmrc.agentclientmanagementfrontend.controllers.routes
@import uk.gov.hmrc.agentclientmanagementfrontend.views.AuthorisedAgentsPageConfig
@import uk.gov.hmrc.agentclientmanagementfrontend.views.html.main_template
@import uk.gov.hmrc.agentclientmanagementfrontend.views.html.components._
@import uk.gov.hmrc.agentclientmanagementfrontend.models.AgentRequest
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTabs
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.Tabs
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.TabItem
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.html.components.GovukTable
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.Table
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.HeadCell
@import uk.gov.hmrc.govukfrontend.views.viewmodels.table.TableRow
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.HtmlContent
@import uk.gov.hmrc.govukfrontend.views.viewmodels.tabs.TabPanel

@this(
    mainTemplate: main_template,
    govukTabs: GovukTabs,
    govukTable: GovukTable,
    p:p, h1:h1, h2:h2, ul:ul, a:a
)

@(config: AuthorisedAgentsPageConfig)(implicit msgs: Messages, request: Request[_], appConfig: AppConfig, now: LocalDate)

@pendingNo = @{
    if(config.validPendingCount == 1) {
    msgs("client-authorised-agents-table-relationships.pendingNo.single", config.validPendingCount)
    }else {
    msgs("client-authorised-agents-table-relationships.pendingNo", config.validPendingCount)
    }
}

@currentRequests = {
    @govukTable(Table(
        head = Some(Seq(
            HeadCell(content = Text(msgs("client-authorised-agents-table.current.agentName"))),
            HeadCell(content = Text(msgs("client-authorised-agents-table.current.taxService"))),
            HeadCell(content = Text(msgs("client-authorised-agents-table.current.expiryDate"))),
            HeadCell(content = Text(msgs("client-authorised-agents-table.current.action")))
        )),
        rows = config.displayValidPendingRequests.map { agentReq =>
          Seq(
            TableRow(content = Text(agentReq.agencyName), attributes = Map("style" -> "font-weight: bold")),
            TableRow(content = Text(agentReq.serviceName)),
            TableRow(content = Text(config.displayDate(Some(agentReq.expiryDate)))),
            TableRow(content = HtmlContent(Html(
                s"""<a href="${appConfig.warmUpUrl(agentReq.clientType, agentReq.uid, agentReq.agencyName)}">
                   |    <span aria-hidden="true">${msgs("client-authorised-agents-table.actions.respond")}</span>
                   |    <span class="govuk-visually-hidden">${msgs("client-authorised-agents-table.actions.respond")} ${agentReq.agencyName} ${agentReq.serviceName}</span>
                   |    </a>
                   |""".stripMargin)
            )),
          )
        }
    ))
}

@currentAuths = {
    @h2("client-authorised-agents-table-relationships.tab2.title")
    @if(!config.authorisedAgentsExist) {
      @p("client-authorised-agents-table-content.noAgentsFound")
    } else {
      @govukTable(Table(
        head = Some(Seq(
          HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.agentName"))),
          HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.authServices"))),
          HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.dateAuthorised"))),
          HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.actions")))
        )),
        rows = config.authorisedAgents.map { authAgent =>
          Seq(
            TableRow(content = Text(authAgent.agencyName), attributes = Map("style" -> "font-weight: bold")),
            TableRow(content = Text(msgs(s"client-authorised-agents-table-content.${authAgent.serviceName}"))),
            TableRow(content = Text(config.displayDate(authAgent.dateFrom))),
            TableRow(content = if (!appConfig.featuresRemoveAuthorisation(authAgent.serviceName)) Text("") else
              HtmlContent(
                s"""<a href="${routes.ClientRelationshipManagementController.showRemoveAuthorisation(authAgent.serviceName, authAgent.uuId)}">
                   |    <span aria-hidden="true"> ${msgs("client-authorised-agents-table-row-header.unauthoriseLink")}</span>
                   |    <span class="govuk-visually-hidden">${msgs("client-authorised-agents-table-row-header.unauthoriseLink.aria-text", authAgent.agencyName, msgs(s"client-authorised-agents-table-content.${authAgent.serviceName}"))}</span>
                   |</a>
                   |""".stripMargin
              )
            )
          )
        }
      ))
    }
}

@history = {
   @h2("client-authorised-agents-table-relationships.tab3.title")
   @if(!config.validNonPendingRequestsExist) {
       @p("client-authorised-agents-table-content.no-activity")
   } else {
     <div class="govuk-body govuk-!-margin-0">
         @msgs("pager.showing")
         <span style="font-weight: bold">@{config.firstItemOnPage + 1}</span>
         @msgs("pager.to")
         <span style="font-weight: bold">@{config.lastItemOnPage}</span>
         @msgs("pager.of")
         <span style="font-weight: bold">@{config.allItems.length}</span>
     </div>
     @govukTable(Table(
       head = Some(Seq(
         HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.agentName"))),
         HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.authRequested"))),
         HeadCell(content = Text(msgs("client-authorised-agents-table-row-header.status"))),
       )),
       rows = config.visibleItems.sortWith(_.agencyName < _.agencyName).sorted(AgentRequest.orderingByLastUpdated).map { agentReq =>
         Seq(
           TableRow(content = Text(agentReq.agencyName), attributes = Map("style" -> "font-weight: bold")),
           TableRow(content = Text(msgs(s"client-authorised-agents-table-content.${agentReq.serviceName}"))),
           TableRow(content = HtmlContent(s"""${msgs(s"client-authorised-agents-table.${agentReq.status}")}
                                             |<span class="date-hint">${config.displayDate(Some(agentReq.lastUpdated.toLocalDate))}</span>
                                             |""".stripMargin)
           )
         )
       }
     ))
     @pager(config)
   }
}

@tabItems = @{
    val currentRequestsTab = TabItem(id = Some("currentRequests"), label = msgs("client-authorised-agents-table-relationships.tab1.title"), panel = TabPanel(content = HtmlContent(currentRequests)))
    val currentAuthsTab    = TabItem(id = Some("currentAuths"), label = msgs("client-authorised-agents-table-relationships.tab2.title"), panel = TabPanel(content = HtmlContent(currentAuths)))
    val historyTab         = TabItem(id = Some("history"), label = msgs("client-authorised-agents-table-relationships.tab3.title"), panel = TabPanel(content = HtmlContent(history)))
    if (config.validPendingRequestsExist)
      Seq(currentRequestsTab, currentAuthsTab, historyTab)
    else
      Seq(currentAuthsTab, historyTab)
}

@mainTemplate(title = msgs("client-authorised-agents.title"), fullWidth = true){

    @h1("client-authorised-agents.title")
    @p("client-authorised-agents.p")
    @ul(
        items=Seq(
            "client-authorised-agents.li.1",
            "client-authorised-agents.li.2",
            "client-authorised-agents.li.3",
            "client-authorised-agents.li.4",
        )
    )

    <p class="govuk-!-margin-bottom-6">
        @a(href="https://www.gov.uk/guidance/client-authorisation-an-overview#how-to-change-or-cancel-authorisations-as-an-agent",
            key="client-authorised-agents.link.text")
    </p>

    @govukTabs(Tabs(
        items = tabItems
    ))

}
